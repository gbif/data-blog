<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Finding gridded datasets - GBIF Data Blog</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="John Waller" />
  <meta name="description" content="Gridded datasets are a known problem at GBIF. Many datasets have equally-spaced points in a regular pattern. These datasets are usually systematic national surveys or data taken from some atlas (&amp;ldquo;so-called rasterized collection designs&amp;rdquo;).
" />

  <meta name="keywords" content="Hugo, theme, even" />






<meta name="generator" content="Hugo 0.91.2" />


<link rel="canonical" href="https://data-blog.gbif.org/post/finding-gridded-datasets/" />

<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">







<link href="/dist/even.min.css?v=3.2.0" rel="stylesheet">




<link rel="stylesheet" href="/css//custom.css">


<meta property="og:title" content="Finding gridded datasets" />
<meta property="og:description" content="Gridded datasets are a known problem at GBIF. Many datasets have equally-spaced points in a regular pattern. These datasets are usually systematic national surveys or data taken from some atlas (&ldquo;so-called rasterized collection designs&rdquo;)." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://data-blog.gbif.org/post/finding-gridded-datasets/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2018-08-14T00:00:00+00:00" />
<meta property="article:modified_time" content="2018-08-14T15:47:18+02:00" />

<meta itemprop="name" content="Finding gridded datasets">
<meta itemprop="description" content="Gridded datasets are a known problem at GBIF. Many datasets have equally-spaced points in a regular pattern. These datasets are usually systematic national surveys or data taken from some atlas (&ldquo;so-called rasterized collection designs&rdquo;)."><meta itemprop="datePublished" content="2018-08-14T00:00:00+00:00" />
<meta itemprop="dateModified" content="2018-08-14T15:47:18+02:00" />
<meta itemprop="wordCount" content="1632">
<meta itemprop="keywords" content="rstats,data quality,gridded data," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Finding gridded datasets"/>
<meta name="twitter:description" content="Gridded datasets are a known problem at GBIF. Many datasets have equally-spaced points in a regular pattern. These datasets are usually systematic national surveys or data taken from some atlas (&ldquo;so-called rasterized collection designs&rdquo;)."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">GBIF Data Blog</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/categories/gbif/">
        <li class="mobile-menu-item">posts</li>
      </a><a href="https://discourse.gbif.org/c/data-blog">
        <li class="mobile-menu-item">community-forum</li>
      </a><a href="https://www.gbif.org/">
        <li class="mobile-menu-item">gbif.org</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">about</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">
	<img src= "/logo.png" alt="GBIF-analytics-blog" style ="width:20%;">
  </a>
  
	
  
  
</div>

<nav class="site-navbar">

  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/categories/gbif/">posts</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="https://discourse.gbif.org/c/data-blog">community-forum</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="https://www.gbif.org/">gbif.org</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">about</a>
      </li>
  </ul>
</nav>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
	
    <header class="post-header">
      <h1 class="post-title">Finding gridded datasets</h1>
	  
	  
      <div class="post-author">John Waller</div>

      <div class="post-meta">
        <span class="post-time"> 2018-08-14 </span>
        <div class="post-category">
            
              <a href="/categories/gbif/"> GBIF </a>
            
          </div>
        
        
      </div>
    </header>

    
    

    
    

    
    <div class="post-content">
      <p>Gridded datasets are a known problem at GBIF. Many datasets have equally-spaced points in a regular pattern. These datasets are usually systematic national surveys or data taken from some atlas (&ldquo;so-called rasterized collection designs&rdquo;).</p>
<blockquote>
<p>In this blog post I will describe how I found gridded dataset in GBIF.</p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/jhnwllr/charts/master/gridSnap.gif" width="60%" height="60%"
style="display: block;margin-left: auto;margin-right: auto;"/></p>
<h3 id="what-is-the-problem">What is the problem?</h3>
<p>Users might assume that their underlying data is reflecting a highly precise measurement of a location, but coordinates collected on a low precision might be unsuitable for species distribution modelling or some other study. Right now a user making a download at GBIF has no way of knowing if the big blob occurrence points they downloaded contains a gridded dataset. <strong>This is a problem</strong> because users might assume more precision <strong>than what is present in the download</strong>.</p>
<h3 id="how-i-quantified-griddy-ness">How I quantified griddy-ness</h3>
<p>After a little bit of trial and error, I arrived at a simple dataset feature (or measure):</p>
<blockquote>
<p>Percentage of unique lat-long points 
with the most common nearest neighbor distance</p>
</blockquote>
<center><h1>Gridded Example</h1> </center>
<p><img src="https://raw.githubusercontent.com/jhnwllr/charts/master/griddedNN.gif" width="60%" height="60%"
style="display: block;margin-left: auto;margin-right: auto;"/></p>
<center><h1>Random Example</h1> </center>
<p><img src="https://raw.githubusercontent.com/jhnwllr/charts/master/notGriddedNN.gif" width="60%" height="60%"
style="display: block;margin-left: auto;margin-right: auto;"/></p>
<h3 id="good-things-about-this-feature">Good things about this feature:</h3>
<ul>
<li>Easy to compute</li>
<li>Easy to understand</li>
<li>Scale independent</li>
<li>Single dimensional</li>
</ul>
<h3 id="bad-things-about-this-feature">Bad things about this feature:</h3>
<ul>
<li>Sensitive to small differences between points</li>
<li>Sensitive to small datasets</li>
</ul>
<h3 id="how-to-fix-the-bad-things">How to fix the bad things:</h3>
<ul>
<li>Filter out small datasets</li>
<li>Round distances to nearest minimum distance (I chose 0.01 decimal degrees), which is around 1 km.</li>
<li>Filter out datasets with most common distances below the 0.01 minimum.</li>
<li>Filter out datasets with very few remaing unique lat-long points after filtering below 0.01 minimum.</li>
</ul>
<h3 id="most-gridded-datasets-seem-to-be-located-in-europe">Most gridded datasets seem to be located in Europe</h3>
<p><img src="https://raw.githubusercontent.com/jhnwllr/charts/master/whereGriddedLocated.gif" width="80%" height="80%"
style="display: block;margin-left: auto;margin-right: auto;"/></p>
<h2 id="results">Results</h2>
<ul>
<li>There are around <strong>400</strong> gridded datasets within GBIF.</li>
<li>This represents around <strong>10% of the 4000 large datasets</strong> (&gt; 20 unique lat-long points)</li>
<li><strong>France publishes the most gridded datasets</strong> with 228 gridded datasets.</li>
<li>Not all rasterized or gridded datasets are a perfect square and there is a spectrum of griddyness.</li>
<li>At least <strong>75M</strong> occurrence records are gridded above 0.01 degrees.</li>
<li>Most datasets (370) are <strong>gridded at 0.1°</strong> and only <strong>12 datasets are gridded at greater than 0.40°</strong> and 33 datasets are gridded <strong>below 0.1°</strong>.</li>
</ul>
<h2 id="you-can-manually-review-all-datasets-that-passed-my-filters">You can manually review all datasets that passed my filters</h2>
<p>I have also plotted each of the datasets that have passed some basic filters  <a href="https://github.com/jhnwllr/griddedDatasets/blob/master/pdf/reviewGriddedPlots.pdf">here</a>. Around <strong>530</strong> datasets are large enough and well sampled enough to review.</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#268bd2">library</span>(dplyr)

<span style="color:#586e75"># first load the griddedDataSets.csv</span>
urlFile <span style="color:#719e07">=</span> <span style="color:#2aa198">&#39;https://raw.githubusercontent.com/jhnwllr/griddedDatasets/master/csv/griddedDataSets.csv&#39;</span>
griddedDataSets <span style="color:#719e07">=</span> <span style="color:#268bd2">read.table</span>(<span style="color:#268bd2">url</span>(urlFile),header<span style="color:#719e07">=</span><span style="color:#cb4b16">TRUE</span>,sep<span style="color:#719e07">=</span><span style="color:#2aa198">&#34;\t&#34;</span>,fill<span style="color:#719e07">=</span><span style="color:#cb4b16">TRUE</span>,quote<span style="color:#719e07">=</span><span style="color:#2aa198">&#34;&#34;</span>)

griddedDataSets <span style="color:#719e07">=</span> 
griddedDataSets <span style="color:#719e07">%&gt;%</span> 
<span style="color:#268bd2">filter</span>(countNN <span style="color:#719e07">&gt;</span> <span style="color:#2aa198">30</span>) <span style="color:#719e07">%&gt;%</span> <span style="color:#586e75"># only get datasets with a reasonable count of NN distances </span>
<span style="color:#268bd2">filter</span>(distanceNN <span style="color:#719e07">&gt;</span> <span style="color:#2aa198">0.02</span>) <span style="color:#586e75"># filter out distances close to minimum 0.01 (important!)</span>
<span style="color:#268bd2">nrow</span>(griddedDataSets) <span style="color:#586e75"># datasets in the pdf</span>
</code></pre></div><h2 id="i-want-to-filter-gridded-datasets-from-my-download">I want to filter gridded datasets from my download!</h2>
<p>I have processed all occurrence datasets in GBIF and produced a griddyness score for each based off of nearest neighbor distances (described above).</p>
<h3 id="disclaimers">disclaimers</h3>
<ul>
<li>Only datasets with <strong>more than 20 unique</strong> lat-long points were processed.</li>
<li>Datasets were downloaded in <strong>August of 2018</strong>, so new datasets might not be in the csv.</li>
<li><strong>Mixed datasets</strong> might not be caught unless a large percentage of points are gridded.</li>
<li>Only the <strong>first 1000 points</strong> were downloaded from each dataset, so large datasets that are gridded but only have a few unique lat-lon points will not be caught.</li>
<li>Only looked for datasets on a grid <strong>larger than 0.01</strong> decimal degrees.</li>
<li>Not all 15k occurrence datasets are capable of being classified.</li>
<li>The griddedDataSets.csv contains <strong>4698 datasets</strong> of around 15,000 occurrence datasets with various levels of griddyness.</li>
<li>Most datasets within GBIF have less than 20 unique lat-long points (from a sample of 1000 points) and are therefore difficult to classify as gridded or random.</li>
<li>Even <strong>non-gridded datasets</strong> might not necessarily have an extremely precise lat-long occurrence records.</li>
</ul>
<h3 id="column-definitions-for-griddeddatasetscsv">Column definitions for griddedDataSets.csv</h3>
<ul>
<li>datasetKey - GBIF dataset key.</li>
<li>publishingCountry - Country that published the dataset.</li>
<li>occCount - Total number of occurrence records in the dataset.</li>
<li>datasetTitle - Title of dataset.</li>
<li>percentNN - Fraction of unique lat-long points with the most common nearest neighbor distance.</li>
<li>distanceNN - The most common nearest neighbor distance to the nearest 0.01 degrees.</li>
<li>countNN - The count of unique lat-long points with the most common nearest neighbor distance.</li>
<li>uniqueLatLon - The number of unique lat-long points in the dataset.</li>
<li>lastUpdated - When I downloaded the data from GBIF.</li>
<li>numberSampled - number of points sampled from each dataset. Will be 1000 for each.</li>
</ul>
<p>You can download the file here <a href="https://github.com/jhnwllr/griddedDatasets/blob/master/csv/griddedDataSets.csv">griddedDataSets.csv</a>.</p>
<h3 id="setting-the-percentnn-parameter">Setting the percentNN parameter</h3>
<p>Below is a basic example of how to filter a GBIF download in R with griddedDataSets.csv. The main variable to adjust is the <strong>percentNN</strong> or fraction of unique lat-long points with the most common distance.</p>
<ul>
<li>greater than 0.75 will likely remove only gridded datasets from a download, leaving all random datasets but also many gridded datasets.</li>
<li>greater than 0.50 will remove most gridded datasets but few random.</li>
<li>greater than <strong>0.30</strong> will likely remove almost all gridded datasets (<strong>recommended</strong>).</li>
<li>lower than <strong>0.30</strong> will likely only remove mostly non-gridded datasets (too conservative).</li>
</ul>
<h2 id="r-code-to-filter-out-gridded-datasets">R-code to filter out gridded datasets</h2>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#586e75"># filtering out gridded datasets</span>

<span style="color:#268bd2">library</span>(rgbif)
<span style="color:#268bd2">library</span>(dplyr)

<span style="color:#586e75"># first load the griddedDataSets.csv</span>
urlFile <span style="color:#719e07">=</span> <span style="color:#2aa198">&#39;https://raw.githubusercontent.com/jhnwllr/griddedDatasets/master/csv/griddedDataSets.csv&#39;</span>
griddedDataSets <span style="color:#719e07">=</span> <span style="color:#268bd2">read.table</span>(<span style="color:#268bd2">url</span>(urlFile),header<span style="color:#719e07">=</span><span style="color:#cb4b16">TRUE</span>,sep<span style="color:#719e07">=</span><span style="color:#2aa198">&#34;\t&#34;</span>,fill<span style="color:#719e07">=</span><span style="color:#cb4b16">TRUE</span>,quote<span style="color:#719e07">=</span><span style="color:#2aa198">&#34;&#34;</span>)

griddedDataSets <span style="color:#719e07">=</span> 
griddedDataSets <span style="color:#719e07">%&gt;%</span> 
<span style="color:#268bd2">filter</span>(countNN <span style="color:#719e07">&gt;</span> <span style="color:#2aa198">30</span>) <span style="color:#719e07">%&gt;%</span> <span style="color:#586e75"># only get datasets with a reasonable count of NN distances </span>
<span style="color:#268bd2">filter</span>(percentNN <span style="color:#719e07">&gt;</span> <span style="color:#2aa198">0.3</span>) <span style="color:#719e07">%&gt;%</span> <span style="color:#586e75"># only filter datasets with a high percentage </span>
<span style="color:#268bd2">filter</span>(distanceNN <span style="color:#719e07">&gt;</span> <span style="color:#2aa198">0.02</span>) <span style="color:#586e75"># filter out distances close to minimum 0.01 (important!)</span>

<span style="color:#586e75"># Download Data</span>
<span style="color:#586e75"># Emberiza bruniceps; 500 Red-headed bunting records from France</span>
buntingData <span style="color:#719e07">=</span> <span style="color:#268bd2">occ_search</span>(taxonKey <span style="color:#719e07">=</span> <span style="color:#2aa198">2491521</span>,country <span style="color:#719e07">=</span> <span style="color:#2aa198">&#34;FR&#34;</span>,limit<span style="color:#719e07">=</span><span style="color:#2aa198">500</span>,return<span style="color:#719e07">=</span><span style="color:#2aa198">&#34;data&#34;</span>)

<span style="color:#268bd2">nrow</span>(buntingData) <span style="color:#586e75"># only total records 269 (September 2018)</span>

<span style="color:#268bd2">unique</span>(buntingData<span style="color:#719e07">$</span>datasetKey) <span style="color:#586e75"># 4 datasets</span>

<span style="color:#586e75"># should find 2 gridded datasets</span>
<span style="color:#268bd2">unique</span>(buntingData<span style="color:#719e07">$</span>datasetKey) <span style="color:#719e07">%in%</span> griddedDataSets<span style="color:#719e07">$</span>datasetKey 
cleanBuntingData <span style="color:#719e07">=</span> buntingData[<span style="color:#719e07">!</span>buntingData<span style="color:#719e07">$</span>datasetKey <span style="color:#719e07">%in%</span> griddedDataSets<span style="color:#719e07">$</span>datasetKey,] 

<span style="color:#586e75"># only 4 occurrence records for Emberiza bruniceps found not in gridded datasets</span>
<span style="color:#268bd2">nrow</span>(buntingData) 
</code></pre></div><p>In the future, I may consider downloading a larger sample from each GBIF dataset in order to catch such cases.</p>
<h1 id="coordiante-cleaner-r-package">Coordiante Cleaner R package</h1>
<p><a href="https://azizka.github.io/CoordinateCleaner/articles/Background_dataset_level_cleaning.html">Coordiante Cleaner</a> is an R package written by Alexander Zizka. This package utilizes the <strong>cd_round</strong> function to find gridded or rasterized datasets. It uses a different methodology than what is described here, but is definitely worth taking a look at.</p>
<h1 id="potential-improvements">Potential improvements</h1>
<h3 id="different-projections">Different Projections</h3>
<p>Throughout this post I have implicitly been assuming all coordinates are projected using WGS84, but this might not be the case. For example, the UK uses something called <a href="https://en.wikipedia.org/wiki/Ordnance_Survey_National_Grid">Ordnance Survey National Grid</a>, and there probably other projections that might have caused me to miss a gridded dataset.</p>
<h3 id="multiples-of-the-most-common-distance">Multiples of the most common distance</h3>
<p>One could imagine looking for multiples of the most common distance as a way of detecting gridded datasets. This has the potential to improve performance, but it might also not help very much since we will likely be finding datasets that are already very &lsquo;griddy&rsquo; and square.</p>
<h3 id="looking-for-gridded-datasets-spaced-smaller-than-001-degrees">Looking for gridded datasets spaced smaller than 0.01 degrees</h3>
<p>There are probably many gridded datasets at smaller than 0.01 degrees. I chose not to look for these datasets since most environmental and climate data are at a resolution equal to or higher than 0.01 degrees.</p>
<h3 id="sampling-more-than-1000-records-from-each-dataset">Sampling more than 1000 records from each dataset</h3>
<p>Probably the main issue preventing me finding all gridded datasets is low sampling. Large gridded datasets, but with very few unique lat-long points, will not be well sampled enough at 1000 records. <strong>Probably higher sampling will locate more datasets</strong>.</p>
<h3 id="computing-griddy-ness-scores-for-a-new-download-expensive">Computing griddy-ness scores for a new download (expensive)</h3>
<p>One might want to compute griddy-ness scores for a new download. Or we might want to increase the sampling of the datasets to be more confident that we are catching all gridded datasets. This can be done in pricipal using <a href="https://cran.r-project.org/web/packages/rgbif/index.html">rgbif</a>. In general though this process will take longer and <strong>might be difficult to acheive if there are very many datasets</strong>.</p>
<div class="highlight"><pre tabindex="0" style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#268bd2">library</span>(rgbif)
<span style="color:#268bd2">library</span>(dplyr) 

<span style="color:#586e75"># Function to compute nearest neighbor features for a new download</span>
<span style="color:#586e75"># D - input data from a GBIF download</span>
<span style="color:#586e75"># key - focal key </span>
<span style="color:#586e75"># k - number of nearest neighbors to compute </span>

getNNFeature <span style="color:#719e07">=</span> <span style="color:#268bd2">function</span>(D,key,k) { <span style="color:#586e75"># nearest neighbor features </span>
  D <span style="color:#719e07">=</span> D <span style="color:#719e07">%&gt;%</span> <span style="color:#268bd2">filter</span>(datasetKey <span style="color:#719e07">==</span> key)
  
  <span style="color:#586e75"># nearest neighbors distances</span>
  NN <span style="color:#719e07">=</span> FNN<span style="color:#719e07">::</span><span style="color:#268bd2">get.knn</span>(<span style="color:#268bd2">cbind</span>(D<span style="color:#719e07">$</span>decimalLongitude,D<span style="color:#719e07">$</span>decimalLatitude), k<span style="color:#719e07">=</span>k)<span style="color:#719e07">$</span>nn.dist 
  
  <span style="color:#586e75"># Nearest Neighbor Percent Feature </span>
  minimum <span style="color:#719e07">=</span> <span style="color:#2aa198">0.01</span>
  NN <span style="color:#719e07">=</span> <span style="color:#268bd2">round</span>(NN,<span style="color:#2aa198">2</span>) <span style="color:#586e75"># round nearest neighbors nearest 0.01</span>
  <span style="color:#586e75"># adjust precision of rounding to any desired </span>
  <span style="color:#586e75"># NN = plyr::round_any(NN,0.01,ceiling) </span>
  
  TL <span style="color:#719e07">=</span> <span style="color:#268bd2">apply</span>(NN,<span style="color:#2aa198">2</span>,table) <span style="color:#586e75"># table list</span>
  <span style="color:#586e75"># distances less than minimum </span>
  boolL <span style="color:#719e07">=</span> <span style="color:#268bd2">lapply</span>(TL,<span style="color:#268bd2">function</span>(x) <span style="color:#268bd2">as.numeric</span>(<span style="color:#268bd2">names</span>(x)) <span style="color:#719e07">&gt;</span> minimum) 
  
  <span style="color:#586e75"># filter out those distances less than minimum</span>
  <span style="color:#268bd2">T</span> <span style="color:#719e07">=</span> <span style="color:#268bd2">list</span>(); <span style="color:#268bd2">for</span>(i in <span style="color:#2aa198">1</span><span style="color:#719e07">:</span><span style="color:#268bd2">length</span>(TL)) <span style="color:#268bd2">T</span>[[i]] <span style="color:#719e07">=</span> TL[[i]][boolL[[i]]] 
  
  NNC <span style="color:#719e07">=</span> <span style="color:#268bd2">sapply</span>(<span style="color:#268bd2">T</span>,<span style="color:#268bd2">function</span>(x) <span style="color:#268bd2">rev</span>(<span style="color:#268bd2">sort</span>(x))[1]) <span style="color:#586e75"># NN point count</span>
  NNPF <span style="color:#719e07">=</span> <span style="color:#268bd2">sapply</span>(<span style="color:#268bd2">T</span>,<span style="color:#268bd2">function</span>(x) <span style="color:#268bd2">rev</span>(<span style="color:#268bd2">sort</span>(x))[1]<span style="color:#719e07">/</span><span style="color:#268bd2">sum</span>(x)) <span style="color:#586e75"># NN feature </span>
  MCD <span style="color:#719e07">=</span> <span style="color:#268bd2">as.numeric</span>(<span style="color:#268bd2">names</span>(NNPF)) <span style="color:#586e75"># most common distances of NN </span>
  
  NNF <span style="color:#719e07">=</span> <span style="color:#268bd2">cbind</span>(
  <span style="color:#268bd2">rbind</span>(NNC) <span style="color:#719e07">%&gt;%</span> <span style="color:#268bd2">as.data.frame</span>() <span style="color:#719e07">%&gt;%</span> <span style="color:#268bd2">setNames</span>(<span style="color:#268bd2">paste0</span>(<span style="color:#2aa198">&#34;NNC&#34;</span>,<span style="color:#2aa198">1</span><span style="color:#719e07">:</span>k)),
  <span style="color:#268bd2">rbind</span>(NNPF) <span style="color:#719e07">%&gt;%</span> <span style="color:#268bd2">as.data.frame</span>() <span style="color:#719e07">%&gt;%</span> <span style="color:#268bd2">setNames</span>(<span style="color:#268bd2">paste0</span>(<span style="color:#2aa198">&#34;NNPF&#34;</span>,<span style="color:#2aa198">1</span><span style="color:#719e07">:</span>k)),
  <span style="color:#268bd2">rbind</span>(MCD) <span style="color:#719e07">%&gt;%</span> <span style="color:#268bd2">as.data.frame</span>() <span style="color:#719e07">%&gt;%</span> <span style="color:#268bd2">setNames</span>(<span style="color:#268bd2">paste0</span>(<span style="color:#2aa198">&#34;MCD&#34;</span>,<span style="color:#2aa198">1</span><span style="color:#719e07">:</span>k))
  )
  
  NNF<span style="color:#719e07">$</span>key <span style="color:#719e07">=</span> key <span style="color:#586e75"># add key </span>
  NNF<span style="color:#719e07">$</span>uniqueLatLon <span style="color:#719e07">=</span> <span style="color:#268bd2">nrow</span>(D)
  
  <span style="color:#268bd2">return</span>(NNF) <span style="color:#586e75"># return the nearest neighbor feature </span>
}

<span style="color:#586e75"># Download Data</span>
<span style="color:#586e75"># Emberiza bruniceps; 500 Red-headed bunting records from France</span>
buntingData <span style="color:#719e07">=</span> <span style="color:#268bd2">occ_search</span>(taxonKey <span style="color:#719e07">=</span> <span style="color:#2aa198">2491521</span>,country <span style="color:#719e07">=</span> <span style="color:#2aa198">&#34;FR&#34;</span>,limit<span style="color:#719e07">=</span><span style="color:#2aa198">500</span>,return<span style="color:#719e07">=</span><span style="color:#2aa198">&#34;data&#34;</span>)

keys <span style="color:#719e07">=</span> <span style="color:#268bd2">unique</span>(buntingData<span style="color:#719e07">$</span>datasetKey)
sampleSize <span style="color:#719e07">=</span> <span style="color:#2aa198">2000</span> <span style="color:#586e75"># change to increase the sample size </span>

<span style="color:#586e75"># download a sample of data from each dataset in the download from the api </span>
DL <span style="color:#719e07">=</span> <span style="color:#268bd2">lapply</span>(keys,<span style="color:#268bd2">function</span>(x) {
<span style="color:#268bd2">occ_data</span>(datasetKey<span style="color:#719e07">=</span>x,hasGeospatialIssue<span style="color:#719e07">=</span><span style="color:#cb4b16">FALSE</span>,hasCoordinate<span style="color:#719e07">=</span><span style="color:#cb4b16">TRUE</span>,limit<span style="color:#719e07">=</span>sampleSize)<span style="color:#719e07">$</span>data
}) 
occRecords <span style="color:#719e07">=</span> plyr<span style="color:#719e07">::</span><span style="color:#268bd2">rbind.fill</span>(DL) 

<span style="color:#586e75"># aggregate data </span>
occRecords <span style="color:#719e07">=</span> occRecords <span style="color:#719e07">%&gt;%</span> 
  <span style="color:#268bd2">group_by</span>(datasetKey) <span style="color:#719e07">%&gt;%</span> 
  <span style="color:#268bd2">select</span>(decimalLatitude,decimalLongitude) <span style="color:#719e07">%&gt;%</span> 
  <span style="color:#268bd2">count</span>(decimalLongitude,decimalLatitude) <span style="color:#719e07">%&gt;%</span> <span style="color:#268bd2">as.data.frame</span>()


<span style="color:#586e75"># compute the actual features </span>
FL <span style="color:#719e07">=</span> <span style="color:#268bd2">list</span>() <span style="color:#586e75"># feature list</span>
<span style="color:#268bd2">for</span>(key in keys) {
	<span style="color:#586e75"># sometimes this feature fails because </span>
	<span style="color:#586e75"># there are no points with NN dist greater than 0.01</span>
	out<span style="color:#719e07">=</span><span style="color:#268bd2">try</span>(<span style="color:#268bd2">getNNFeature</span>(D<span style="color:#719e07">=</span>occRecords,key,k<span style="color:#719e07">=</span><span style="color:#2aa198">4</span>))
		<span style="color:#268bd2">if</span>(<span style="color:#268bd2">class</span>(out) <span style="color:#719e07">==</span> <span style="color:#2aa198">&#34;try-error&#34;</span>) next 
	FL[[key]] <span style="color:#719e07">=</span> out
}
<span style="color:#268bd2">F</span> <span style="color:#719e07">=</span> plyr<span style="color:#719e07">::</span><span style="color:#268bd2">rbind.fill</span>(FL) <span style="color:#586e75"># griddyness features </span>

griddedDataSets <span style="color:#719e07">=</span> <span style="color:#268bd2">F</span> <span style="color:#719e07">%&gt;%</span> 
  <span style="color:#268bd2">select</span>(key,NNPF1,MCD1,NNC1,uniqueLatLon) <span style="color:#719e07">%&gt;%</span>
  <span style="color:#268bd2">setNames</span>(<span style="color:#268bd2">c</span>(<span style="color:#2aa198">&#34;datasetKey&#34;</span>,<span style="color:#2aa198">&#34;percentNN&#34;</span>,<span style="color:#2aa198">&#34;distanceNN&#34;</span>,<span style="color:#2aa198">&#34;countNN&#34;</span>,<span style="color:#2aa198">&#34;uniqueLatLon&#34;</span>))

<span style="color:#586e75"># set parameters to filter with </span>
griddedDataSets <span style="color:#719e07">=</span> 
griddedDataSets <span style="color:#719e07">%&gt;%</span> 
<span style="color:#268bd2">filter</span>(countNN <span style="color:#719e07">&gt;</span> <span style="color:#2aa198">30</span>) <span style="color:#719e07">%&gt;%</span> <span style="color:#586e75"># only get datasets with a reasonable count of NN distances </span>
<span style="color:#268bd2">filter</span>(percentNN <span style="color:#719e07">&gt;</span> <span style="color:#2aa198">0.3</span>) <span style="color:#719e07">%&gt;%</span> <span style="color:#586e75"># only filter datasets with a high percentage </span>
<span style="color:#268bd2">filter</span>(distanceNN <span style="color:#719e07">&gt;</span> <span style="color:#2aa198">0.02</span>) <span style="color:#586e75"># filter out distances close to minimum 0.01 (important!)</span>


<span style="color:#268bd2">unique</span>(buntingData<span style="color:#719e07">$</span>datasetKey) <span style="color:#719e07">%in%</span> griddedDataSets<span style="color:#719e07">$</span>datasetKey 
cleanBuntingData <span style="color:#719e07">=</span> buntingData[<span style="color:#719e07">!</span>buntingData<span style="color:#719e07">$</span>datasetKey <span style="color:#719e07">%in%</span> griddedDataSets<span style="color:#719e07">$</span>datasetKey,] 

</code></pre></div>
    </div>

    
    

    
    

    <footer class="post-footer">
      <div class="post-tags">
          
          <a href="/tags/rstats/">rstats</a>
          
          <a href="/tags/data-quality/">data quality</a>
          
          <a href="/tags/gridded-data/">gridded data</a>
          
        </div>

      
      <nav class="post-nav">
        
          <a class="prev" href="/post/gbif-citizen-science/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Finding citizen science datasets on GBIF</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        
          <a class="next" href="/post/gbif-download-trends/">
            <span class="next-text nav-default">GBIF download trends</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

      </div>
    </main>

    <footer id="footer" class="footer">
      


 
<div>
<h3>This post represents the ideas of the author.</h3>
</div>
<div id='discourse-comments'></div>
<script type="text/javascript">
  DiscourseEmbed = { discourseUrl: 'https://discourse.gbif.org/',
                     discourseEmbedUrl: 'https://data-blog.gbif.org\/post\/finding-gridded-datasets\/' };

  (function() {
    var d = document.createElement('script'); d.type = 'text/javascript'; d.async = true;
    d.src = DiscourseEmbed.discourseUrl + 'javascripts/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(d);
  })();
</script>  


<div class = "copyright">
	<a class="theme-link" href="https://www.gbif.org/what-is-gbif">What is GBIF?</a>
	<span class="division">|</span>
	<a class="theme-link" href="https://www.gbif.org/developer/summary">API</a> 
	<span class="division">|</span>
	<a class="theme-link" href="https://www.gbif.org/faq">FAQ</a>
	<span class="division">|</span>
	<a class="theme-link" href="https://discourse.gbif.org/">Community-Forum</a>
</div>

<div class = "copyright"> 
	<span class="theme-info">GBIF Secretariat</span> 
	<span class="theme-info">Universitetsparken 15</span> 
	<span class="theme-info">DK-2100 Copenhagen Ø</span> 
	<span class="theme-info" >Denmark</span>
</div>

<div class="copyright">
	<span class="power-by">
	Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
	</span>
	<span class="division">|</span>
	<span class="theme-info">
	Theme - 
	<a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
	</span>

</div>
    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
<script src="/lib/highlight/highlight.pack.js?v=20171001"></script><script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  


<script type="text/javascript" src="/dist/even.min.js?v=3.2.0"></script>








</body>
</html>
